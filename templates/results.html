{% extends "layout.html" %}

{% block title %}Search Results{% endblock %}

{% block content %}

{# ... (summary and parameters blocks unchanged) ... #}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Search Results</h2>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">« New Search</a>
</div>

<div class="card mb-4 results-summary">
    <div class="card-body">
        <h5 class="card-title">Search Parameters Used</h5>
        <p><strong>Formula:</strong> {{ search_params.formula or 'N/A' }}</p>
        <p><strong>Structural Constraints:</strong> {{ search_params.structure_keys|join(', ') if search_params.structure_keys else 'None' }}</p>
        <p><strong>NMR Signals Constraint:</strong> {{ search_params.nmr_signals_str if search_params.nmr_signals_str else (search_params.nmr_signals if search_params.nmr_signals is not none else 'None') }}</p>
        <p><strong>NMR Ratio Constraint:</strong> {{ search_params.nmr_ratio_str if search_params.nmr_ratio_str else (':'.join(search_params.nmr_ratio|map('string')) if search_params.nmr_ratio else 'None') }}</p>
    </div>
</div>

{% if warning %}
    <div class="alert alert-warning" role="alert">
        <strong>Warning:</strong> {{ warning }}
    </div>
{% endif %}
{% if error %}
    <div class="alert alert-danger error-message" role="alert">
        <strong>Error during search/display:</strong> {{ error }}
    </div>

{% elif total_found == 0 %}
     <div class="alert alert-info" role="alert">
         <strong>No compounds found</strong> matching all specified criteria.
     </div>

{% else %}
    <div class="alert alert-success" role="alert">
        Found <strong>{{ total_found }}</strong> compound(s) matching all criteria.
        {% if total_found != final_cids|length and final_cids|length > 0 %}
            (Showing details/list for the first {{ final_cids|length }}.)
        {% elif not final_cids and total_found > 0 %}
             (Result list was too long to display.)
        {% endif %}
    </div>

    {% if final_cids and detailed_results %}
        <h3 class="mt-4">Details for the First {{ detailed_results|length }} Result(s)</h3>
        {% for cid, details in detailed_results.items() %}
            <div class="result-card">
                <h3>{{ loop.index }}. {{ details.get('Title', 'N/A') }} (CID: {{ cid }})</h3>
                <dl>
                    <dt>IUPAC Name:</dt> <dd>{{ details.get('IUPACName', 'N/A') }}</dd>
                    <dt>SMILES:</dt> <dd>{{ details.get('IsomericSMILES', 'N/A') }}</dd>
                    <dt>InChIKey:</dt> <dd>{{ details.get('InChIKey', 'N/A') }}</dd>
                    <dt>Predicted H NMR:</dt> <dd>{{ details.get('PredictedNMR', 'N/A') }}</dd>
                    <dt>Description:</dt>
                    <dd>
                        {% if details.get('Description') %}
                             {{ details.get('Description') | truncate(300) }}
                        {% else %} N/A {% endif %}
                    </dd>
                    <dt>PubChem Link:</dt> <dd><a href="{{ details.get('PubChemLink', '#') }}" target="_blank" rel="noopener noreferrer">{{ details.get('PubChemLink', 'N/A') }}</a></dd>
                    <dt>2D Structure:</dt>
                    <dd>
                        {% if details.get('ImageLink') %}
                             <a href="{{ details.get('ImageLink', '#') }}" target="_blank" rel="noopener noreferrer">
                                 {# *** ADD loading="lazy" HERE *** #}
                                 <img src="{{ details.get('ImageLink') }}"
                                      alt="Structure of CID {{ cid }}"
                                      loading="lazy"
                                      width="{{ DETAIL_IMAGE_WIDTH }}" {# Explicit width/height helps layout #}
                                      height="{{ DETAIL_IMAGE_HEIGHT }}">
                             </a>
                        {% else %} N/A {% endif %}
                    </dd>
                </dl>
            </div>
        {% endfor %}
    {% elif final_cids and not error %}
         <p class="mt-4 text-muted">Details could not be loaded for the top results.</p>
    {% endif %}

    {# --- Summary CID List --- #}
     {% if final_cids %}
        {# (CID list logic remains the same) #}
        <h3 class="mt-4">Full List of Matching CIDs ({{ total_found }} total{% if total_found != final_cids|length %}, showing {{ final_cids|length }}{% endif %})</h3>
        {% if final_cids|length > max_cids_summary %}
            <p class="text-muted">(Showing first and last {{ max_cids_summary // 2 }})</p>
            <div class="cid-list">
                 {{ final_cids[:max_cids_summary // 2]|join(', ') }}
                 <br>...<br>
                 {{ final_cids[-(max_cids_summary // 2):]|join(', ') }}
            </div>
        {% else %}
             <div class="cid-list"> {{ final_cids|join(', ') }} </div>
        {% endif %}
     {% elif total_found > 0 %}
          <h3 class="mt-4">List of Matching CIDs</h3>
          <p class="text-danger">The list of {{ total_found }} CIDs was too long to be included in the URL.</p>
     {% endif %}

{% endif %} {# End of results found block #}

<div class="mt-4 text-center">
     <a href="{{ url_for('index') }}" class="btn btn-secondary">« Perform Another Search</a>
</div>

{% endblock %}